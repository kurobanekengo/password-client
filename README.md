# 開発環境構築メモ
Vagrantを使用し開発を行う。
ソースファイルはホスト上に配置しゲスト側からはsynced_foldersにより共有したホストのファイルを参照する。

## 共有方式
rsync方式を使用する。当初NFSの使用を試みたが問題が多かったので使用を断念した。

### NFS方式の問題点
ホスト上でソースファイルを編集した際にゲストOS側にファイルの変更を検知してもらえず
webpack-dev-serverによるwatchを動作させることができなかった。

原因はNFS経由のファイル更新でファイル更新イベントが正しく伝わらないため。
この問題を解決するにはwatchOptionsをpollingにする必要がある。

#### ※追記1
pollingを使用してもNFSによるキャッシュが作用してファイルの最新化されるまでに長い時間がかかる。
解決するためにはNFSのオプションを指定してキャッシュ間隔を短くする対応が必要になる。

#### ※追記2
開発パフォーマンスをあげるためにHMRの導入を試みたところNFS経由でファイル編集した場合HMRが正しく動作しないことがわかった。

## 開発手順
### ソース編集時
- ホスト上で`vagrant rsync-auto`でファイル転送を開始する。

### webapp動作時
- ホスト上で`npm i`しパッケージをインストールする。(IDE上でソース編集する際のimportの解決等に必要)
- ゲスト上で`npm i`しパッケージをインストールする。(実際にwebappを動作させる際に必要)
- `npm start`する

### 新パッケージ追加時
- ホスト上で`npm i 新パッケージ`し、新規パッケージをインストールする(=ホスト上のpackage.jsonが更新される→ゲストに転送される)
- ゲスト上で`npm i`しパッケージをインストールする。

## トラブルシューティング
webpackにより生成された成果物はゲスト上にのみ存在するため、rsyncが発生するとゲスト上のファイルが削除されてしまう。
削除されないようにするために`rsync__exclude`を使用し指定したディレクトリを転送対象外にしていたが、なぜかある段階で
(もしくは元々動作していなかった可能性もあるが)この設定が適用されずにファイルが削除されてしまう現象が発生するようになった。

ひとまずWeb記事の調査により以下の解決法を見つけたのでメモしておく。

```
vagrant halt
rm -rf .vagrant/machines/default/virtualbox/synched_folders
vagrant up
```

いったん解決した(ように見える)のでしばらく様子見とする。

[参考記事](https://www.lancard.com/blog/2015/04/07/vagrant-rsync-auto-%E3%81%A7-rsync__exclude-%E3%82%92%E5%A4%89%E6%9B%B4%E3%81%97%E3%81%A6%E3%82%82%E5%8F%8D%E6%98%A0%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88/)
